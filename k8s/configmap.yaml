apiVersion: v1
kind: ConfigMap
metadata:
  name: medical-ai-config
  namespace: medical-ai
data:
  # 应用配置
  APP_NAME: "Medical AI Platform"
  APP_VERSION: "1.0.0"
  ENVIRONMENT: "production"
  DEBUG: "false"
  
  # 服务器配置
  HOST: "0.0.0.0"
  PORT: "8000"
  WORKERS: "4"
  
  # 数据库配置
  DATABASE_ECHO: "false"
  DATABASE_POOL_SIZE: "10"
  DATABASE_MAX_OVERFLOW: "20"
  DATABASE_POOL_TIMEOUT: "30"
  DATABASE_POOL_RECYCLE: "3600"
  
  # Redis配置
  REDIS_DB: "0"
  
  # JWT配置
  ALGORITHM: "HS256"
  ACCESS_TOKEN_EXPIRE_MINUTES: "30"
  REFRESH_TOKEN_EXPIRE_DAYS: "7"
  
  # 安全配置
  CORS_CREDENTIALS: "true"
  
  # 文件存储配置
  UPLOAD_DIR: "/app/uploads"
  MAX_FILE_SIZE: "104857600"  # 100MB
  
  # AI模型配置
  MODEL_PATH: "/app/models"
  MODEL_CACHE_SIZE: "5"
  INFERENCE_TIMEOUT: "30"
  BATCH_SIZE: "8"
  
  # 监控配置
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_INTERVAL: "30"
  
  # 日志配置
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"
  LOG_MAX_SIZE: "10485760"  # 10MB
  LOG_BACKUP_COUNT: "5"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: medical-ai
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    
    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
        
        # 日志格式
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        
        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;
        
        # Gzip压缩
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;
        
        # 限流配置
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
        
        # 后端服务
        upstream backend {
            least_conn;
            server medical-ai-backend:8000 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }
        
        server {
            listen 80;
            server_name _;
            
            # 客户端最大请求体大小
            client_max_body_size 100M;
            
            # 前端静态文件
            location / {
                root /usr/share/nginx/html;
                index index.html index.htm;
                try_files $uri $uri/ /index.html;
                
                # 缓存静态资源
                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            
            # API路由
            location /api/ {
                limit_req zone=api burst=20 nodelay;
                
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                # 超时设置
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
                
                # 缓冲设置
                proxy_buffering on;
                proxy_buffer_size 4k;
                proxy_buffers 8 4k;
            }
            
            # WebSocket支持
            location /ws/ {
                proxy_pass http://backend;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            # 认证端点限流
            location /api/auth/ {
                limit_req zone=login burst=5 nodelay;
                
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            # 健康检查
            location /health {
                proxy_pass http://backend/health;
                access_log off;
            }
            
            # 拒绝访问敏感文件
            location ~ /\. {
                deny all;
            }
            
            location ~ \.(env|log|conf)$ {
                deny all;
            }
        }
    }